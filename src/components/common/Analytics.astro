---
import { ANALYTICS } from 'astrowind:config';
---

{ANALYTICS?.enabled && (
  <script define:vars={{ ANALYTICS }} is:inline>
    if (typeof window !== 'undefined' && !window.__balizenAnalyticsInitialized) {
      window.__balizenAnalyticsInitialized = true;

      const config = ANALYTICS;
      const state = {
        gaLoaded: false,
        gtmLoaded: false,
        fbPixelInitialized: false,
      };

      window.dataLayer = window.dataLayer || [];
      window.gtag =
        window.gtag ||
        function gtag() {
          window.dataLayer.push(arguments);
        };

      window.gtag('consent', 'default', {
        ad_storage: 'denied',
        analytics_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        wait_for_update: 500,
      });

      function loadGoogleAnalytics() {
        if (state.gaLoaded || !config?.vendors?.googleAnalytics?.id) {
          return;
        }

        state.gaLoaded = true;
        const script = document.createElement('script');
        script.src = `https://www.googletagmanager.com/gtag/js?id=${config.vendors.googleAnalytics.id}`;
        script.async = true;
        document.head.appendChild(script);

        window.gtag('js', new Date());
        window.gtag('config', config.vendors.googleAnalytics.id, {
          anonymize_ip: true,
        });
      }

      function loadGoogleTagManager() {
        if (state.gtmLoaded || !config?.vendors?.googleTagManager?.id) {
          return;
        }

        state.gtmLoaded = true;
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({
            'gtm.start': new Date().getTime(),
            event: 'gtm.js',
          });
          const f = d.getElementsByTagName(s)[0];
          const j = d.createElement(s);
          const dl = l !== 'dataLayer' ? `&l=${l}` : '';
          j.async = true;
          j.src = `https://www.googletagmanager.com/gtm.js?id=${i}${dl}`;
          f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', config.vendors.googleTagManager.id);
      }

      function loadFacebookPixel() {
        if (state.fbPixelInitialized || !config?.vendors?.facebookPixel?.id) {
          return;
        }

        !(function (f, b, e, v, n, t, s) {
          if (f.fbq) return;
          n = f.fbq = function () {
            n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);
          };
          if (!f._fbq) f._fbq = n;
          n.push = n;
          n.loaded = !0;
          n.version = '2.0';
          n.queue = [];
          t = b.createElement(e);
          t.async = !0;
          t.src = v;
          s = b.getElementsByTagName(e)[0];
          s.parentNode.insertBefore(t, s);
        })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

        window.fbq('init', `${config.vendors.facebookPixel.id}`);
        window.fbq('consent', 'grant');
        window.fbq('track', 'PageView');

        state.fbPixelInitialized = true;
        window.facebookPixelLoaded = true;
      }

      function updateConsent(granted) {
        const consentStatus = granted
          ? {
              ad_storage: 'granted',
              analytics_storage: 'granted',
              ad_user_data: 'granted',
              ad_personalization: 'granted',
            }
          : {
              ad_storage: 'denied',
              analytics_storage: 'denied',
              ad_user_data: 'denied',
              ad_personalization: 'denied',
            };

        window.gtag('consent', 'update', consentStatus);

        if (granted) {
          loadGoogleAnalytics();
          loadGoogleTagManager();
          loadFacebookPixel();
        } else if (window.fbq && state.fbPixelInitialized) {
          window.fbq('consent', 'revoke');
        }
      }

      function readCookieConsent() {
        const cookie = document.cookie
          .split('; ')
          .find((row) => row.startsWith('cc_cookie='));

        if (!cookie) {
          return false;
        }

        try {
          const value = decodeURIComponent(cookie.split('=')[1] || '');
          if (!value) {
            return false;
          }
          const data = JSON.parse(value);
          const categories = data?.categories ?? [];
          return categories.includes('analytics');
        } catch (error) {
          console.error('Failed to parse cookie consent prefs', error);
          return false;
        }
      }

      updateConsent(readCookieConsent());

      const handleConsentEvent = (event) => {
        try {
          const categories = event.detail?.cookie?.categories ?? [];
          updateConsent(categories.includes('analytics'));
        } catch (error) {
          console.error('Unable to process consent event', error);
        }
      };

      window.addEventListener('cc:onConsent', handleConsentEvent);
      window.addEventListener('cc:onChange', handleConsentEvent);
    }
  </script>
)}
