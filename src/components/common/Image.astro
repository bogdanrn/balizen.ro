---
import type { HTMLAttributes } from 'astro/types';

import { findImage } from '../../utils/images';
import {
  astroAsseetsOptimizer,
  getImagesOptimized,
  isUnpicCompatible,
  unpicOptimizer,
  type ImageProps,
} from '../../utils/images-optimization';

type Props = ImageProps;
type OptimizedImage = {
  src: string;
  attributes: HTMLAttributes<'img'>;
};

const props = Astro.props as Props;

if (props.alt === undefined || props.alt === null) {
  throw new Error('Image component requires an alt attribute for accessibility.');
}

if (typeof props.width === 'string') {
  props.width = parseInt(props.width, 10);
}

if (typeof props.height === 'string') {
  props.height = parseInt(props.height, 10);
}

props.loading ??= 'lazy';
props.decoding ??= 'async';

const resolvedImage = await findImage(props.src);
let optimized: OptimizedImage | undefined;

if (
  typeof resolvedImage === 'string' &&
  (resolvedImage.startsWith('http://') || resolvedImage.startsWith('https://')) &&
  isUnpicCompatible(resolvedImage)
) {
  optimized = await getImagesOptimized(resolvedImage, props, unpicOptimizer);
} else if (resolvedImage) {
  optimized = await getImagesOptimized(resolvedImage, props, astroAsseetsOptimizer);
}
---

{
  optimized ? (
    <img src={optimized.src} crossorigin="anonymous" referrerpolicy="no-referrer" {...optimized.attributes} />
  ) : (
    <Fragment />
  )
}
