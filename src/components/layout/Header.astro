---
import Logo from './Logo.astro';
import LanguageSwitcher from '../common/LanguageSwitcher.astro';
import { getLangFromUrl } from '../../i18n/utils';
import { getSiteConfig } from '../../utils/content';
import { cn } from '../../utils/cn';

const lang = getLangFromUrl(Astro.url);
const siteConfig = getSiteConfig(lang);
const { header } = siteConfig;
const navLinks = header.links ?? [];
const primaryAction = header.primaryAction;

const containerClasses = [
  'mx-auto flex w-full items-center justify-between gap-6 px-4 py-4 transition-all',
  header.fullWidth ? 'max-w-screen-xl' : 'max-w-5xl',
].join(' ');
---

<header class="lg:sticky top-0 z-40 border-b border-slate-200 bg-white/80 backdrop-blur lg:bg-white/70">
  <div class={containerClasses}>
    <Logo />

    <div class="flex items-center gap-2 lg:hidden">
      <LanguageSwitcher />
      <button
        class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
        type="button"
        aria-label={lang === 'ro' ? 'Deschide meniul' : 'Open menu'}
        data-nav-toggle
      >
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>

    <nav
      class="hidden flex-1 items-center justify-end gap-10 text-sm font-medium uppercase tracking-wide text-slate-700 lg:flex"
      data-nav-menu
    >
      {
        navLinks.map((link) => (
          <a
            href={link.href}
            class={cn('transition-colors hover:text-primary whitespace-nowrap', link.class)}
            target={link.target}
            rel={link.rel}
          >
            {link.label}
          </a>
        ))
      }

      {
        primaryAction && (
          <a
            href={primaryAction.href}
            class={cn(
              'whitespace-nowrap rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:opacity-90',
              primaryAction.class
            )}
            target={primaryAction.target}
            rel="noopener"
          >
            {primaryAction.label}
          </a>
        )
      }
      <LanguageSwitcher />
    </nav>
  </div>

  <div class="border-t border-slate-200 bg-white px-4 py-4 shadow-sm lg:hidden" hidden data-nav-drawer>
    <nav class="space-y-3 text-sm font-medium uppercase tracking-wide text-slate-700">
      {
        navLinks.map((link) => (
          <a
            href={link.href}
            class={cn(
              'flex items-center justify-between rounded-lg bg-slate-50 px-4 py-3 transition hover:bg-slate-100 whitespace-nowrap',
              link.class
            )}
            target={link.target}
            rel={link.rel}
          >
            <span>{link.label}</span>
            <svg class="h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
        ))
      }

      {
        primaryAction && (
          <a
            href={primaryAction.href}
            class={cn(
              'mt-4 flex items-center justify-center rounded-full bg-primary px-4 py-3 text-sm font-semibold text-white transition hover:opacity-90 whitespace-nowrap',
              primaryAction.class
            )}
            target={primaryAction.target}
            rel="noopener"
          >
            {primaryAction.label}
          </a>
        )
      }
      <div class="mt-4">
        <LanguageSwitcher />
      </div>
    </nav>
  </div>
</header>

<script>
  const toggle = document.querySelector('[data-nav-toggle]');
  const drawer = document.querySelector('[data-nav-drawer]');
  const menu = document.querySelector('[data-nav-menu]');

  if (toggle && drawer) {
    const toggleDrawer = () => {
      const isHidden = drawer.hasAttribute('hidden');
      if (isHidden) {
        drawer.removeAttribute('hidden');
        toggle.setAttribute('aria-expanded', 'true');
        toggle.innerHTML = `
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        `;
      } else {
        drawer.setAttribute('hidden', '');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.innerHTML = `
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        `;
      }
    };

    toggle.addEventListener('click', toggleDrawer);

    drawer.addEventListener('click', (event) => {
      if (event.target instanceof HTMLElement && event.target.tagName === 'A') {
        drawer.setAttribute('hidden', '');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.innerHTML = `
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        `;
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) {
        drawer.setAttribute('hidden', '');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
  }

  if (menu) {
    menu.querySelectorAll('a').forEach((anchor) => {
      anchor.addEventListener('focus', () => menu.classList.add('underline-offset-4'));
      anchor.addEventListener('blur', () => menu.classList.remove('underline-offset-4'));
    });
  }
</script>
