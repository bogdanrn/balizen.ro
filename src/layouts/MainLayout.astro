---
import '~/assets/styles/tailwind.css';

import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import ThemeStyles from '../components/layout/ThemeStyles.astro';
import Analytics from '../components/common/Analytics.astro';
import BookingConsentModal from '../components/common/BookingConsentModal.astro';
import SchemaMarkup from '../components/common/SchemaMarkup.astro';
import { getLangFromUrl } from '../i18n/utils';
import { getSiteConfig } from '../utils/content';
import { METADATA } from 'astrowind:config';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  noIndex?: boolean;
}

const lang = getLangFromUrl(Astro.url);
const siteConfig = getSiteConfig(lang);

const {
  title = `${siteConfig.brand.name} · ${siteConfig.brand.tagline}`,
  description = siteConfig.brand.description,
  image,
  noIndex = false,
} = Astro.props;

const bookingModalId = 'booking-consent-modal';

const bookingPolicies = {
  ro: [
    { label: 'Politica de confidențialitate (GDPR)', href: '/privacy-policy' },
    { label: 'Termeni și condiții de utilizare', href: '/terms-policy' },
    { label: 'Politica de rambursare', href: '/return-policy' },
    { label: 'Politica de anulare', href: '/cancellation-policy' },
  ],
  en: [
    { label: 'Privacy Policy', href: '/en/privacy-policy' },
    { label: 'Terms and Conditions', href: '/en/terms-policy' },
    { label: 'Return Policy', href: '/en/return-policy' },
    { label: 'Cancellation Policy', href: '/en/cancellation-policy' },
  ],
};

const bookingTranslations = {
  ro: {
    title: 'Programări online – confirmare necesară',
    description:
      'Pentru a continua cu programarea online, confirmă că ai citit și ești de acord cu politicile Bali Zen referitoare la programări, plăți și anulări.',
    confirmLabel: 'Confirm și continuă programarea',
    cancelLabel: 'Revin mai târziu',
    skipToContent: 'Sari la conținut',
  },
  en: {
    title: 'Online Booking – Confirmation Required',
    description:
      'To continue with online booking, please confirm that you have read and agree to Bali Zen policies regarding bookings, payments, and cancellations.',
    confirmLabel: 'Confirm and continue booking',
    cancelLabel: 'Return later',
    skipToContent: 'Skip to content',
  },
};

const t = bookingTranslations[lang];
const policies = bookingPolicies[lang];
---

<!doctype html>
<html lang={lang} class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    {/* Open Graph / Facebook */}
    <meta property="og:type" content={METADATA?.openGraph?.type || 'website'} />
    <meta property="og:url" content={Astro.site ? new URL(Astro.url.pathname, Astro.site).href : Astro.url.href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content={METADATA?.openGraph?.site_name || siteConfig.brand.name} />
    {image && (
      <>
        <meta property="og:image" content={image} />
        {METADATA?.openGraph?.images?.[0]?.width && (
          <meta property="og:image:width" content={String(METADATA.openGraph.images[0].width)} />
        )}
        {METADATA?.openGraph?.images?.[0]?.height && (
          <meta property="og:image:height" content={String(METADATA.openGraph.images[0].height)} />
        )}
      </>
    )}
    
    {/* Twitter */}
    <meta name="twitter:card" content="summary_large_image" />
    {image && <meta name="twitter:image" content={image} />}
    <script is:inline define:vars={{ currentLang: lang }}>
      // Set language BEFORE cookie consent initializes - must be first
      (function() {
        if (typeof window !== 'undefined' && document.documentElement) {
          // Set HTML lang attribute immediately
          document.documentElement.setAttribute('lang', currentLang);
          
          // Store language for cookie consent
          window.__cookieConsentLang = currentLang;
          
          // Intercept cookie consent initialization if possible
          const originalAddEventListener = window.addEventListener;
          window.addEventListener = function(type, listener, options) {
            if (type === 'DOMContentLoaded' || type === 'load') {
              // Ensure lang is set before any initialization
              setTimeout(() => {
                if (document.documentElement) {
                  document.documentElement.setAttribute('lang', currentLang);
                }
              }, 0);
            }
            return originalAddEventListener.call(this, type, listener, options);
          };
        }
      })();
    </script>
    <ThemeStyles />
    <Analytics />
    <SchemaMarkup />
    <script is:inline define:vars={{ currentLang: lang }}>
      // Set cookie consent language after initialization
      if (typeof window !== 'undefined') {
        const setLanguage = () => {
          // Ensure HTML lang is correct
          if (document.documentElement) {
            document.documentElement.setAttribute('lang', currentLang);
          }
          
          // Try to set via cookie consent API
          if (window.CC && typeof window.CC.setLanguage === 'function') {
            try {
              window.CC.setLanguage(currentLang);
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            } catch (_e) {
              // Silent fail
            }
          }
        };
        
        // Multiple attempts at different intervals
        [0, 50, 100, 200, 500, 1000, 2000].forEach((delay) => {
          setTimeout(setLanguage, delay);
        });
        
        // Listen for cookie consent events
        window.addEventListener('cc:onInit', setLanguage, { once: true });
        window.addEventListener('cc:onReady', setLanguage, { once: true });
      }
    </script>
  </head>
  <body class="flex min-h-screen flex-col bg-white text-slate-900 antialiased">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded focus:bg-white focus:px-3 focus:py-2 focus:text-sm focus:font-semibold focus:text-primary"
    >
      {t.skipToContent}
    </a>
    <Header />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />
    <BookingConsentModal
      id={bookingModalId}
      title={t.title}
      description={t.description}
      policies={policies}
      confirmLabel={t.confirmLabel}
      cancelLabel={t.cancelLabel}
    />
    <script is:inline define:vars={{ bookingUrl: siteConfig.contact.bookingUrl, modalId: bookingModalId }}>
      (() => {
        const attachHandlers = (root = document) => {
          const programButtons = root.querySelectorAll('.js-programari-button');

          programButtons.forEach((button) => {
            if (button.dataset.bookingBound === 'true') {
              return;
            }

            button.dataset.bookingBound = 'true';

            button.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();

              if (window.facebookPixelLoaded && typeof window.fbq === 'function') {
                window.fbq('track', 'ViewContent', {
                  content_name: 'Programare',
                  content_category: 'Programare',
                  content_ids: ['programare'],
                });
              }

              const openModal = window[`showModal_${modalId}`];
              if (typeof openModal === 'function') {
                openModal();
              } else {
                window.open(bookingUrl, '_blank', 'noopener,noreferrer');
              }
            });
          });

          const bindTracking = (selector, callback) => {
            root.querySelectorAll(selector).forEach((element) => {
              if (element.dataset.trackingBound === 'true') {
                return;
              }

              element.dataset.trackingBound = 'true';
              element.addEventListener('click', () => {
                if (window.facebookPixelLoaded && typeof window.fbq === 'function') {
                  callback();
                }
              });
            });
          };

          bindTracking('.js-contact-button', () => window.fbq('track', 'Contact'));
          bindTracking('.js-location-button', () => window.fbq('track', 'FindLocation'));
        };

        const initialize = () => attachHandlers(document);

        if (window.__balizenBookingScriptInitialized) {
          initialize();
          return;
        }

        window.__balizenBookingScriptInitialized = true;

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initialize, { once: true });
        } else {
          initialize();
        }

        document.addEventListener('astro:after-swap', () => attachHandlers(document));

        document.addEventListener('modalConfirm', (event) => {
          if (event.detail?.modalId === modalId) {
            window.open(bookingUrl, '_blank', 'noopener,noreferrer');
          }
        });
      })();
    </script>
  </body>
</html>
